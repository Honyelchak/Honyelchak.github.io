import{_ as p}from"./plugin-vue_export-helper-x3n3nnut.js";import{r as o,o as c,c as l,e as a,w as t,f as n,b as e}from"./app-_dQeDwys.js";const i="/assets/image-20200314174849867-65xkllzf.png",u="/assets/image-20200314174837868-31TWSpCY.png",r="/assets/image-20200314175824875-kJ4Pvhzb.png",d={},k=n('<h1 id="reentrantlock中的lockinterruptibly、lock、trylock" tabindex="-1"><a class="header-anchor" href="#reentrantlock中的lockinterruptibly、lock、trylock" aria-hidden="true">#</a> ReentrantLock中的lockInterruptibly、lock、tryLock</h1><p>这篇文章的思路：</p><ul><li>首先尝试着阅读Java文档(双语对照)</li><li>了解几个关键类之间的关系</li><li>通过源代码来了解lock和lockInterruptibly的流程</li><li>最后总结两者的区别</li></ul><h2 id="java文档-双语" tabindex="-1"><a class="header-anchor" href="#java文档-双语" aria-hidden="true">#</a> Java文档(双语)</h2><h3 id="lock" tabindex="-1"><a class="header-anchor" href="#lock" aria-hidden="true">#</a> lock</h3><blockquote><ol><li><p>Acquires the lock unless the current thread is interrupted.</p><p><strong>获得锁，除非当前线程被中断。</strong></p></li><li><p>Acquires the lock if it is not held by another thread and returns immediately, setting the lock hold count to one.</p><p><strong>如果锁未被另一个线程持有，则获取该锁并立即返回，将锁持有计数设置为1。</strong></p></li><li><p>If the current thread already holds this lock then the hold count is incremented by one and the method returns immediately.</p><p><strong>如果当前线程已经持有此锁，则保持计数将增加1，并且方法将立即返回。</strong></p></li><li><p>If the lock is held by another thread then the current thread becomes disabled for thread scheduling purposes and lies dormant until the lock has been acquired, at which time the lock hold count is set to one.</p><p><strong>如果锁被另一个线程持有，则当前线程将因线程调度而禁用，并处于休眠状态，<mark>直到获得锁为止，此时锁持有计数设置为1</mark>。</strong></p></li></ol></blockquote><p>**PS：**注意高亮文字，下面要用。</p><hr><h3 id="lockinterruptibly" tabindex="-1"><a class="header-anchor" href="#lockinterruptibly" aria-hidden="true">#</a> lockInterruptibly</h3><blockquote><ol><li><p>Acquires the lock unless the current thread is interrupted.</p><p><strong>获得锁，除非当前线程被中断。</strong></p></li><li><p>Acquires the lock if it is not held by another thread and returns immediately, setting the lock hold count to one.</p><p><strong>如果锁未被另一个线程持有，则获取该锁并立即返回，将锁持有计数设置为1。</strong></p></li><li><p>If the current thread already holds this lock then the hold count is incremented by one and the method returns immediately.</p><p><strong>如果当前线程已经持有此锁，则保持计数将增加1，并且方法将立即返回。</strong></p></li><li><p>If the lock is held by another thread then the current thread becomes disabled for thread scheduling purposes and lies dormant until one of two things happens:</p><p><strong>如果锁被另一个线程持有，则当前线程将被禁用以进行线程调度，并处于休眠状态，直到发生以下两种情况之一：</strong></p><ul><li><p>The lock is acquired by the current thread; or</p><p><strong>锁由当前线程获取</strong></p></li><li><p>Some other thread interrupts the current thread.</p><p><strong>其他线程中断当前线程</strong></p></li></ul></li><li><p>If the lock is acquired by the current thread then the lock hold count is set to one.</p><p><strong>如果锁是由当前线程获取的，则锁保持计数设置为1。</strong></p></li><li><p>If the current thread:</p><p><strong>如果当前线程：</strong></p><ul><li><p>has its interrupted status set on entry to this method; or</p><p><strong>在进入此方法时设置了中断状态</strong></p></li><li><p>is interrupted while acquiring the lock,</p><p><strong>或在获取锁时被中断</strong></p></li></ul><p>then InterruptedException is thrown and the current thread&#39;s interrupted status is cleared.</p><p><strong>那么会抛出InterruptedException异常，并且会清除当前线程的中断状态。</strong></p><p>In this implementation, as this method is an explicit interruption point, preference is given to responding to the interrupt over normal or reentrant acquisition of the lock.</p><p><strong>在这个实现中，由于这个方法是一个显式的中断点，所以优先考虑响应中断，而不是对锁的正常获取或可重入获取。</strong></p></li></ol></blockquote><h3 id="trylock" tabindex="-1"><a class="header-anchor" href="#trylock" aria-hidden="true">#</a> tryLock</h3><blockquote><ol><li><p>Acquires the lock only if it is not held by another thread at the time of invocation.</p><p><strong>只有在调用时另一个线程未持有锁时，才获取锁。</strong></p></li><li><p>Acquires the lock if it is not held by another thread and returns immediately with the value true, setting the lock hold count to one. Even when this lock has been set to use a fair ordering policy, a call to tryLock() will immediately acquire the lock if it is available, whether or not other threads are currently waiting for the lock. This &quot;barging&quot; behavior can be useful in certain circumstances, even though it breaks fairness. If you want to honor the fairness setting for this lock, then use tryLock(0, TimeUnit.SECONDS) which is almost equivalent (it also detects interruption).</p><p><strong>如果锁未被另一个线程持有，则获取该锁，并立即返回值true，将锁持有计数设置为1。即使此锁已设置为使用公平排序策略，对tryLock（）的调用也将立即获取该锁（如果该锁可用），无论其他线程当前是否在等待该锁。这种“讨价还价”行为在某些情况下是有用的，即使它破坏了公平。如果您想遵守这个锁的公平性设置，那么使用tryLock（0，TimeUnit.SECONDS），这几乎是等效的（它还检测到中断）。</strong></p></li><li><p>If the current thread already holds this lock then the hold count is incremented by one and the method returns true.</p><p><strong>如果当前线程已经持有此锁，则保持计数将增加1，并且方法返回true。</strong></p></li><li><p>If the lock is held by another thread then this method will return immediately with the value false.</p><p><strong>如果这个锁被另一个线程持有，那么这个方法会立即返回false。</strong></p></li></ol></blockquote><h2 id="核心类之间的关系" tabindex="-1"><a class="header-anchor" href="#核心类之间的关系" aria-hidden="true">#</a> 核心类之间的关系</h2><p>可能看到上边官方文档写的有点晦涩。</p><p>说简单点就是：</p><ul><li><code>lock</code>不会去相应中断。</li><li><code>lockInterruptibly</code>会相应中断。</li></ul><p><strong>接下来我们看看源码：</strong></p><p>看源码之前，先了解一下几个关键类(<code>sync</code>、<code>ReentrantLock</code>、<code>FairSync</code>、<code>NonfairSync</code>)的关系。</p><ul><li><p><code>sync</code>是<code>extends</code>AQS的抽象静态内部类。</p></li><li><p><code>Sync</code>、<code>NonfairSync</code>、<code>FairSync</code>都是<code>ReentrantLock</code>的内部类。</p></li><li><p><code>NonfairSync</code>、<code>FairSync</code>都继承<code>Sync</code>。</p></li></ul>',19),v=n(`<h2 id="阅读源码" tabindex="-1"><a class="header-anchor" href="#阅读源码" aria-hidden="true">#</a> 阅读源码</h2><p>知道了几个关键类的关系之后，我们就可以看<code>lock</code>、<code>lockInterruptibly</code>的源码了：</p><h3 id="lock-1" tabindex="-1"><a class="header-anchor" href="#lock-1" aria-hidden="true">#</a> Lock</h3><p><code>lock</code>的代码实现：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// lock方法调用的是Sync实现类的lock方法(因为lock()方法在Sync中是抽象方法)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sync<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由于Sync有两个实现类，<code>FairSync</code>和<code>NonfairSync</code>两个实现类(区别就是是否为公平锁)</p><p>由于需要照顾篇幅的缘故，在这里就拿<code>NonfairSync</code>来说，她是非公平锁，跟synchronized一样。</p><p><code>NonfairSync</code>中的<code>lock()</code>先利用CAS尝试改变State的值，如果返回true，将当前线程设置为独占线程，如果返回false，则调用<code>acquire()</code>方法</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">NonfairSync</span> <span class="token keyword">extends</span> <span class="token class-name">Sync</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 先介绍一下 compareAndSetState</span>
        <span class="token comment">// 它利用CAS来改变state的值(state是在AQS中的，NonfairSync继承Sync继承AQS)</span>
        <span class="token comment">// 简述CAS:(如果当前内存值等于期望值，那就更新值并返回true;如果不等,返回false)</span>
        <span class="token comment">// 也就是说，如果state在内存中是0，那么就把他修改为1，并return true。</span>
        <span class="token comment">// 否则，直接返回false。</span>
        <span class="token comment">// 2. ReentrantLock中的state表示线程重入锁的次数。</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// 将当前线程设置为独占线程。</span>
            <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token comment">// 以独占模式获取，忽略中断。通过调用至少一次tryAcquire来实现，成功时返回。否则线程将排队，可能会重复阻塞和解除阻塞，调用tryAcquire直到成功。</span>
            <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    省略<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractQueuedSynchronizer</span><span class="token punctuation">{</span>   
    <span class="token comment">// 第一个参数为期望值</span>
    <span class="token comment">// 第二个参数是如果期望值与内存中的值相等的话,需要设置的值。</span>
    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token keyword">int</span> expect<span class="token punctuation">,</span> <span class="token keyword">int</span> update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// See below for intrinsics setup to support this</span>
        <span class="token comment">// 第一个参数是当前对象，第二个是state变量的内存偏移量，利用这两个参数可以找到内存中的值。</span>
        <span class="token comment">// unsafe是一个底层操作类,有大量的native方法。</span>
        <span class="token keyword">return</span> unsafe<span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> stateOffset<span class="token punctuation">,</span> expect<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这是一个短路操作</span>
        <span class="token comment">// 先调用tryAcquire看同步状态是否获取成功</span>
        <span class="token comment">// 若成功，返回true，那么if中的整个表达式就是false，那么acquire方法就执行结束，</span>
        <span class="token comment">// 若失败，返回false，接下来再执行addWaiter()、acquireQueued()方法</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">EXCLUSIVE</span><span class="token punctuation">)</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">selfInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
   	省略<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>因篇幅问题，这里只简单介绍AQS中的<code>addWaiter()</code>、<code>acquireQueued()</code>方法。</p><ul><li><p><code>addWaiter()</code>将当前线程构造为一个<code>Node</code>结点，加入到AQS中的同步队列里。</p></li><li><p><code>acquireQueued()</code></p><blockquote><p>Acquires in exclusive uninterruptible mode for thread already in queue. Used by condition wait methods as well as acquire.</p><p>在队列中的线程会<strong>以不间断、独占的模式去获取锁。</strong></p></blockquote></li></ul><p>总结一下<code>lock()</code>的方法的流程：</p><ul><li><p>先用<code>compareAndSetState(int expect, int value)</code>去尝试修改同步状态(AQS.state)</p><ul><li>若修改成功(即获取到锁)，调用<code>setExclusiveOwnerThread(Thread t)</code>设置当前线程拥有独占式的访问全限，lock()方法执行结束。</li><li>若修改失败(未获得锁)，调用<code>acquire()</code>方法</li></ul></li><li><p><code>acquire()</code>方法会先调用<code>tryAcquire</code>看同步状态是否获取成功。</p><ul><li>若成功(即为拿到锁)，返回true。那么if中的整个表达式就是false，那么acquire方法就执行结束。</li><li>若失败(未拿到锁)，返回false，接下来再执行<code>addWaiter()</code>、<code>acquireQueued()</code>方法。</li></ul></li><li><p><code>addWaiter()</code>将当前线程构造为一个<code>Node</code>结点，加入到AQS中的同步队列里。</p></li><li><p><code>acquireQueued()</code>内部利用<code>for(;;;)</code>死循环去尝试获得锁，</p><ul><li>若获得到锁，那就把该Node从队列中移除，并返回false。那么<code>acquire()</code>调用就结束了</li><li>若没有获得到锁，那就把节点状态改为<code>SIGNAL</code>，然后调用LookSupport.park方法使得当前线程阻塞。 <ul><li>当AQS队列中前驱节点被释放他才会继续执行。</li></ul></li></ul></li></ul><p>到此<code>Lock()</code>详解方法结束！(还不算是特别详细，想再深入的可以读读AQS的源码)</p><hr><h3 id="lockinterruptibly-1" tabindex="-1"><a class="header-anchor" href="#lockinterruptibly-1" aria-hidden="true">#</a> lockInterruptibly</h3><p><code>lockInterruptibly</code>的代码实现：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// ReentrantLock中的lockInterruptibly()方法</span>
<span class="token comment">// 调用的是AQS的acquireInterruptibly()方法(因为Sync继承AQS)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    sync<span class="token punctuation">.</span><span class="token function">acquireInterruptibly</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// AQS的节选代码</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractQueuedSynchronizer</span><span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquireInterruptibly</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 测试当前线程是否已中断，如果是则抛出异常</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果当前线程没有中断，尝试去获取同步状态，</span>
        <span class="token comment">// 如果获取成功(拿到锁),方法调用结束</span>
        <span class="token comment">// 如果获取失败(没有拿到锁),方法调用doAcquireInterruptibly()</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">doAcquireInterruptibly</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    
    <span class="token comment">// 该方法和上边的acquireQueued()类似</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doAcquireInterruptibly</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 利用addWaiter()方法为当前线程创建一个结点，并添加到AQS的队列中</span>
        <span class="token keyword">final</span> <span class="token class-name">Node</span> node <span class="token operator">=</span> <span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">EXCLUSIVE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> failed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 死循环</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 获取到当前线程结点的前驱节点</span>
                <span class="token keyword">final</span> <span class="token class-name">Node</span> p <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">predecessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 如果p是头部节点的话，尝试获取锁</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> head <span class="token operator">&amp;&amp;</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// p获取锁成功之后，把当前线程结点设置为头部节点。然后把p结点移除。</span>
                    <span class="token function">setHead</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 把p结点设置为null，利用垃圾回收</span>
                    p<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// help GC</span>
                    failed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// shouldParkAfterFailedAcquire()方法</span>
                <span class="token comment">// 利用CAS将当前线程结点状态改为SIGNAL，表示当前线程堵塞。</span>
                <span class="token comment">// 1.若修改状态成功，则会执行parkAndCheckInterrupt()使得当前线程堵塞。此时会</span>
                <span class="token comment">// 抛出异常</span>
                <span class="token comment">// 2.若修改状态失败，因短路，会继续循环(此时线程没有堵塞)。</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                    <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>failed<span class="token punctuation">)</span>
                <span class="token function">cancelAcquire</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    省略<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="trylock-1" tabindex="-1"><a class="header-anchor" href="#trylock-1" aria-hidden="true">#</a> tryLock</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// 只获取一次锁，成功则返回true，失败返回false</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> sync<span class="token punctuation">.</span><span class="token function">nonfairTryAcquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">abstract</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Sync</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueuedSynchronizer</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">nonfairTryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 没有获取过锁</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 尝试获取锁</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> acquires<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 将当前线程设置为独占线程。</span>
                <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 判断当前线程是否就是setExclusiveOwnerThread()上次设置的线程</span>
        <span class="token comment">// 判断是否为可重入锁</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> nextc <span class="token operator">=</span> c <span class="token operator">+</span> acquires<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>nextc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// overflow</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Maximum lock count exceeded&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setState</span><span class="token punctuation">(</span>nextc<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="三者的区别" tabindex="-1"><a class="header-anchor" href="#三者的区别" aria-hidden="true">#</a> 三者的区别</h2><p><strong>lockInterruptibly()测试：</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;准备进入同步区&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;执行同步代码&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;线程被中断！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 让main线程获取锁，让thread线程获取锁失败。</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 启动线程</span>
    thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 中断线程</span>
    thread<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出结果：</p><figure><img src="`+i+'" alt="image-20200314174849867" tabindex="0" loading="lazy"><figcaption>image-20200314174849867</figcaption></figure>',28),m=n('<p>如果在上边的例子中<code>debug</code>，会发现thread线程在<code>acquireInterruptibly()</code>抛出异常处。</p><figure><img src="'+u+`" alt="image-20200314174837868" tabindex="0" loading="lazy"><figcaption>image-20200314174837868</figcaption></figure><hr><p><strong>lock测试：</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;准备进入同步区&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;执行同步代码&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出结果：</p><figure><img src="`+r+'" alt="image-20200314175824875" tabindex="0" loading="lazy"><figcaption>image-20200314175824875</figcaption></figure>',7),b=n(`<hr><p><strong>tryLock测试：</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;准备进入同步区&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;等待&quot;</span> <span class="token operator">+</span> i<span class="token operator">++</span> <span class="token operator">+</span> <span class="token string">&quot;次&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>lock<span class="token punctuation">.</span><span class="token function">isLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;执行同步代码&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>结果：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>准备进入同步区
等待<span class="token number">0</span>次
等待<span class="token number">1</span>次
    
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token comment">//省略</span>
    
等待<span class="token number">52</span>次
等待<span class="token number">53</span>次
<span class="token boolean">true</span>
执行同步代码
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>总结：</strong></p><ul><li><code>lockInterruptibly()</code>方法调用后一直阻塞到获得锁，但<strong>优先响应中断信号。</strong></li><li><code>lock()</code>方法调用后一直阻塞直到获取锁。</li><li><code>tryLock()</code>尝试是否能获得锁，如果不能获得立即返回。</li></ul>`,7);function h(y,f){const s=o("center");return c(),l("div",null,[k,a(s,null,{default:t(()=>[e("UML图")]),_:1}),v,a(s,null,{default:t(()=>[e("lockInterruptibly()方法优先相应中断")]),_:1}),m,a(s,null,{default:t(()=>[e("lock()方法不相应中断(会一直卡着)")]),_:1}),b])}const q=p(d,[["render",h],["__file","ReentrantLock中的lockInterruptibly和lock.html.vue"]]);export{q as default};
